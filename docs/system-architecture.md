# 系统架构设计文档

## 1. 架构概述

WebServer 采用分层模块化架构设计，将系统划分为网络层、协议层、业务层和支撑层四个主要层次。各层之间通过清晰的接口进行交互，实现高内聚、低耦合的设计目标。

### 1.1 设计原则

1. **模块化设计**：各功能模块独立实现，便于维护和扩展
2. **高内聚低耦合**：模块内部功能紧密相关，模块间依赖关系简单清晰
3. **可扩展性**：支持功能扩展和性能优化
4. **高性能**：通过线程池、内存池等技术优化性能
5. **安全性**：支持 HTTPS 加密通信和访问控制

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                │
├─────────────────────────────────────────────────────────────┤
│                    业务层 (Business Layer)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Router    │  │ HTTP 处理器  │  │  控制器模块  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    协议层 (Protocol Layer)                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ HTTP 解析器  │  │ HTTP 压缩   │  │ 内容协商器   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    网络层 (Network Layer)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 连接管理器   │  │  HTTP 服务器 │  │ 管道处理器   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    支撑层 (Support Layer)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   配置管理   │  │   日志系统   │  │   内存池     │         │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤         │
│  │   线程池     │  │   限流器     │  │   工具类     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 2. 模块详细设计

### 2.1 网络层

网络层负责处理底层网络通信，包括 TCP 连接管理、数据收发等。

#### 2.1.1 ConnectionManager（连接管理器）
- **职责**：管理所有客户端连接，包括连接的创建、维护和清理
- **主要功能**：
  - 连接数限制（每个IP和每个客户端）
  - Keep-alive 连接支持
  - 连接超时管理
  - 连接统计信息收集

#### 2.1.2 HttpServer（HTTP 服务器）
- **职责**：处理底层网络监听和连接接受
- **主要功能**：
  - 端口监听
  - 连接接受
  - SSL/TLS 握手处理

#### 2.1.3 PipelinedConnectionHandler（管道连接处理器）
- **职责**：处理 HTTP 管道连接
- **主要功能**：
  - 支持 HTTP 请求管道化处理
  - 保持请求响应的顺序性

### 2.2 协议层

协议层负责 HTTP 协议的解析和处理。

#### 2.2.1 HttpParser（HTTP 解析器）
- **职责**：解析 HTTP 请求和构建 HTTP 响应
- **主要功能**：
  - HTTP 请求解析（路径、头部、正文）
  - HTTP 响应构建（状态码、头部、正文）
  - 分块传输编码支持

#### 2.2.2 HttpCompressionMiddleware（HTTP 压缩中间件）
- **职责**：处理 HTTP 数据压缩和解压缩
- **主要功能**：
  - 支持 gzip、deflate 等压缩算法
  - 根据客户端支持情况选择压缩方式

#### 2.2.3 ContentNegotiator（内容协商器）
- **职责**：处理 HTTP 内容协商
- **主要功能**：
  - 根据客户端 Accept 头选择内容类型
  - 根据客户端 Accept-Language 头选择语言

### 2.3 业务层

业务层负责具体的业务逻辑处理。

#### 2.3.1 Router（路由管理器）
- **职责**：将 HTTP 请求的 URL 路径映射到相应的处理函数
- **主要功能**：
  - 动态路由注册
  - 路径匹配和处理函数调用
  - 请求参数传递

#### 2.3.2 HttpProcessor（HTTP 处理器）
- **职责**：协调 HTTP 请求的处理流程
- **主要功能**：
  - 组织请求处理的各个步骤
  - 调用中间件和路由处理器

#### 2.3.3 控制器模块
- **职责**：实现具体的业务逻辑
- **主要功能**：
  - 健康检查接口
  - 业务逻辑处理

### 2.4 支撑层

支撑层提供系统运行所需的基础服务。

#### 2.4.1 Config（配置管理）
- **职责**：加载和管理系统配置
- **主要功能**：
  - JSON 配置文件解析
  - 配置项获取和设置
  - 嵌套配置项支持

#### 2.4.2 Logger（日志系统）
- **职责**：提供日志记录功能
- **主要功能**：
  - 多级别日志记录
  - 文件和控制台双重输出
  - 彩色终端输出

#### 2.4.3 ThreadPool（线程池）
- **职责**：管理线程资源，处理并发任务
- **主要功能**：
  - 工作线程管理
  - 任务队列管理
  - 异步任务执行

#### 2.4.4 MemoryPool（内存池）
- **职责**：优化内存分配和回收
- **主要功能**：
  - 固定大小内存块分配
  - 多级内存池支持不同大小的内存分配
  - 线程安全的内存管理

#### 2.4.5 TokenBucket（令牌桶）
- **职责**：实现请求限流
- **主要功能**：
  - 令牌桶算法实现
  - 请求频率控制

## 3. 数据流设计

### 3.1 请求处理流程

```
1. 客户端发起 HTTP 请求
         ↓
2. 网络层接收请求数据
         ↓
3. 协议层解析 HTTP 请求
         ↓
4. 业务层路由匹配和处理
         ↓
5. 支撑层提供基础服务支持
         ↓
6. 构建 HTTP 响应
         ↓
7. 返回响应给客户端
```

### 3.2 数据结构设计

#### 3.2.1 HttpRequest（HTTP 请求）
- method: 请求方法（GET、POST 等）
- path: 请求路径
- version: HTTP 版本
- headers: 请求头
- body: 请求体

#### 3.2.2 HttpResponse（HTTP 响应）
- status: 状态码
- headers: 响应头
- body: 响应体

#### 3.2.3 ConnectionInfo（连接信息）
- thread: 处理连接的线程
- lastActivity: 最后活动时间
- requestCount: 请求计数
- keepAlive: 是否保持连接
- clientIP: 客户端 IP 地址

## 4. 并发设计

### 4.1 线程模型

WebServer 采用多线程模型处理并发请求：

1. **主线程**：负责监听端口和接受连接
2. **工作线程池**：处理具体的请求
3. **后台线程**：处理连接清理等后台任务

### 4.2 同步机制

#### 4.2.1 互斥锁（Mutex）
用于保护共享资源，如：
- 任务队列
- 连接信息表
- 内存池

#### 4.2.2 条件变量（Condition Variable）
用于线程间通信，如：
- 任务队列非空通知
- 线程池关闭通知

#### 4.2.3 原子操作（Atomic）
用于无锁计数，如：
- 请求计数器
- 运行状态标志

## 5. 安全设计

### 5.1 网络安全

#### 5.1.1 HTTPS 支持
通过 OpenSSL 实现 SSL/TLS 加密通信：
- 证书验证
- 数据加密
- 完整性保护

#### 5.1.2 连接限制
防止资源耗尽攻击：
- 每个 IP 的最大连接数限制
- 每个客户端的最大连接数限制
- 连接超时管理

#### 5.1.3 请求限流
使用令牌桶算法防止 DDOS 攻击：
- 控制请求处理速率
- 限制突发流量

### 5.2 数据安全

#### 5.2.1 配置安全
- 敏感信息加密存储
- 配置文件权限控制

#### 5.2.2 日志安全
- 敏感信息过滤
- 日志文件权限控制

## 6. 性能设计

### 6.1 内存优化

#### 6.1.1 内存池技术
- 减少动态内存分配开销
- 提高内存分配效率
- 减少内存碎片

#### 6.1.2 对象复用
- 连接信息对象复用
- 缓冲区复用

### 6.2 网络优化

#### 6.2.1 Keep-Alive 连接复用
- 减少连接建立开销
- 提高并发处理能力

#### 6.2.2 管道连接处理
- 支持 HTTP 请求管道化
- 提高网络利用率

### 6.3 并发优化

#### 6.3.1 线程池
- 避免频繁创建销毁线程
- 控制系统资源使用

#### 6.3.2 锁优化
- 减小锁粒度
- 避免锁竞争

## 7. 容错设计

### 7.1 异常处理

#### 7.1.1 异常边界
在关键位置设置异常处理边界，防止异常传播导致系统崩溃。

#### 7.1.2 资源清理
使用 RAII 机制确保异常发生时资源能够正确释放。

### 7.2 错误恢复

#### 7.2.1 连接恢复
- 自动关闭异常连接
- 释放相关资源

#### 7.2.2 服务恢复
- 线程异常重启
- 服务降级处理

## 8. 可扩展性设计

### 8.1 插件化架构
- 中间件机制支持功能扩展
- 路由处理器动态注册

### 8.2 配置化管理
- 通过配置文件控制功能开关
- 动态调整系统参数

### 8.3 模块化设计
- 各模块职责单一
- 模块间接口清晰